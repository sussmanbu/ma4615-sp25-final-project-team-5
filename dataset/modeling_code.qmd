---
title: "Modeling Code"
author: "Team 5"
editor: visual
---

---
title: "Modeling Code"
author: "Team 5"
editor: visual
---

```{r}
library(tidyverse)
hiv_clean <- read_rds("https://sussmanbu.github.io/ma4615-sp25-final-project-team-5/dataset_for_shiny/hiv_clean.rds")
pov <- read_csv(here::here("dataset","NYC EH Data Portal - Neighborhood poverty (filtered) (1).csv"))
pov_c <- pov |>
  mutate(midpoint = as.integer(str_extract(TimePeriod, "\\d{4}")) + 2)

models_by_neighborhood <- pov_c |>
  filter(GeoTypeDesc == "UHF 42") |>
  group_by(Geography) |>
  nest() |>
  mutate(
    model = map(data, ~ lm(Percent ~ poly(midpoint, 2), data = .x)),
    newdata = list(tibble(midpoint = 2007:2021)),
    predicted = map2(model, newdata, ~ mutate(.y, estimated_rate = predict(.x, newdata = .y)))
  ) |>
  select(Geography, predicted) |>
  unnest(predicted) |>
  filter(!midpoint %in% c(2007, 2008, 2009, 2014, 2015)) |>
  rename(
    YEAR = midpoint,
    `Neighborhood (U.H.F)` = Geography,
    `Estimated Poverty Rate` = estimated_rate
  )
```

```{r}
race_total <- read_csv(here::here("dataset", "NYC EH Data Portal - Race and ethnicity (filtered) (1).csv"))

rt <- race_total |>
  mutate(midpoint = as.integer(str_extract(TimePeriod, "\\d{4}")) + 2)
```

```{r}
asian_uhf <- rt |>
  filter(GeoTypeDesc == "UHF 42") |>
  group_by(Geography) |>
  nest() |>
  mutate(
    model = map(data, ~ lm(`Asian alone (percent)` ~ poly(midpoint, 2), data = .x)),
    newdata = list(tibble(midpoint = 2007:2021)),
    predicted = map2(model, newdata, ~ mutate(.y, asian_prop = predict(.x, newdata = .y)))
  ) |>
  select(Geography, predicted) |>
  unnest(predicted) |>
  filter(!midpoint %in% c(2007, 2008, 2009, 2014, 2015)) |>
  rename(
    "Neighborhood (U.H.F)" = Geography,
    YEAR = midpoint
  )

black_uhf <- rt |>
  filter(GeoTypeDesc == "UHF 42") |>
  group_by(Geography) |>
  nest() |>
  mutate(
    model = map(data, ~ lm(`Black alone (percent)` ~ poly(midpoint, 2), data = .x)),
    newdata = list(tibble(midpoint = 2007:2021)),
    predicted = map2(model, newdata, ~ mutate(.y, black_prop = predict(.x, newdata = .y)))
  ) |>
  select(Geography, predicted) |>
  unnest(predicted) |>
  filter(!midpoint %in% c(2007, 2008, 2009, 2014, 2015)) |>
  rename(
    "Neighborhood (U.H.F)" = Geography,
    YEAR = midpoint
  )

hispanic_uhf <- rt |>
  filter(GeoTypeDesc == "UHF 42") |>
  group_by(Geography) |>
  nest() |>
  mutate(
    model = map(data, ~ lm(`Hispanic alone (percent)` ~ poly(midpoint, 2), data = .x)),
    newdata = list(tibble(midpoint = 2007:2021)),
    predicted = map2(model, newdata, ~ mutate(.y, hispanic_prop = predict(.x, newdata = .y)))
  ) |>
  select(Geography, predicted) |>
  unnest(predicted) |>
  filter(!midpoint %in% c(2007, 2008, 2009, 2014, 2015)) |>
  rename(
    "Neighborhood (U.H.F)" = Geography,
    YEAR = midpoint
  )

white_uhf <- rt |>
  filter(GeoTypeDesc == "UHF 42") |>
  group_by(Geography) |>
  nest() |>
  mutate(
    model = map(data, ~ lm(`White alone (percent)` ~ poly(midpoint, 2), data = .x)),
    newdata = list(tibble(midpoint = 2007:2021)),
    predicted = map2(model, newdata, ~ mutate(.y, white_prop = predict(.x, newdata = .y)))
  ) |>
  select(Geography, predicted) |>
  unnest(predicted) |>
  filter(!midpoint %in% c(2007, 2008, 2009, 2014, 2015)) |>
  rename(
    "Neighborhood (U.H.F)" = Geography,
    YEAR = midpoint
  )
```

```{r}

```

